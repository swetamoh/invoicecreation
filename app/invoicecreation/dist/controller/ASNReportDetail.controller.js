sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(t,e){"use strict";return t.extend("sap.fiori.invoicecreation.controller.ASNReportDetail",{onInit:function(){this.detailModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.detailModel,"detailModel");this.accdetailModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.accdetailModel,"accdetailModel");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this)},handleRouteMatched:function(t){if(t.getParameter("name")==="ASNReportDetail"){var a=this;sap.ui.core.BusyIndicator.show();var s=this.getOwnerComponent().getModel();var i=t.getParameter("arguments");this.UnitCode=i.UnitCode;this.PoNum=i.PoNum.replace(/-/g,"/");this.PNumAttach=i.PoNum;this.MRNnumber=i.MRNnumber.replace(/-/g,"/");this.AddressCode=i.AddressCode;this.SendToAccDate=i.SendToAccDate.replace(/-/g,"/");this.TillDatePurchaseVal=i.TillDatePurchaseVal;this.DedTds=i.DedTds;this.TotalDebit=i.TotalDebit;this.TotalCredit=i.TotalCredit;this.VoucherType=i.VoucherType;this.AccCode=i.AccCode;this.AccDesc=i.AccDesc;this.ReceiptDate=i.ReceiptDate.replace(/-/g,"/");this.VoucherNumber=i.VoucherNumber.replace(/-/g,"/");if(i.ASNNumber){this.ASNNum=i.ASNNumber}var o="/GetPoDetailstoCreateInvoice";s.read(o,{urlParameters:{$expand:"DocumentRows",UnitCode:this.UnitCode,PoNum:this.PoNum,MRNnumber:this.MRNnumber,AddressCode:this.AddressCode},success:function(t){sap.ui.core.BusyIndicator.hide();var s=t.results.find(t=>t.PONumber===a.PoNum);if(s){a.detailModel.setData(s);a.detailModel.refresh(true);a.detailModel.getData().DocumentRows.results[0].ActualItemRate=a.detailModel.getData().DocumentRows.results[0].ItemRate;a.detailModel.refresh(true);a.MRNDate=a.detailModel.getData().MRNDate;if(a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR BILL PASSING"){a.getAccDetailsBill()}else if(a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR VOUCHER GENERATION"||a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR VOUCHER POSTING"){a.getAccDetailsVoucher()}if(a.ASNNum){a._fetchFilesForASNNum(a.ASNNum)}else{a._fetchFilesForPoNum(a.PNumAttach)}}else{e.error("Data not found")}},error:function(t){sap.ui.core.BusyIndicator.hide();e.error(t.message)}})}},_fetchFilesForASNNum:function(t){var e=this.getView().getModel("catalog2");var a=this.byId("uploadSet");a.removeAllItems();e.read("/Files",{filters:[new sap.ui.model.Filter("AsnNum",sap.ui.model.FilterOperator.EQ,t)],success:function(t){t.results.forEach(function(t){var e=new sap.m.upload.UploadSetItem({fileName:t.fileName,mediaType:t.mediaType,url:t.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:t.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:t.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:t.size.toString()})]});a.addItem(e)})},error:function(t){console.log("Error: "+t)}})},_fetchFilesForPoNum:function(t){var e=this.getView().getModel("catalog1");var a=this.byId("uploadSet");a.removeAllItems();a.setUploadEnabled(false);a.setUploadButtonInvisible(true);e.read("/Files",{filters:[new sap.ui.model.Filter("PNum_PoNum",sap.ui.model.FilterOperator.EQ,t)],success:function(t){t.results.forEach(function(t){var e=new sap.m.upload.UploadSetItem({fileName:t.fileName,mediaType:t.mediaType,url:t.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:t.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:t.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:t.size.toString()})]});e.setVisibleEdit(false).setVisibleRemove(false);a.addItem(e)})},error:function(t){console.log("Error: "+t)}})},onOpenPressed:function(t){t.preventDefault();var e=t.getParameter("item");this._fileName=e.getFileName();this._download(e).then(t=>{var e=window.URL.createObjectURL(t);var a=document.createElement("a");a.href=e;a.setAttribute("download",this._fileName);document.body.appendChild(a);a.click();document.body.removeChild(a)}).catch(t=>{console.log(t)})},_download:function(t){console.log("_download");var e={url:t.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((t,a)=>{$.ajax(e).done((e,a,s)=>{t(e)}).fail(t=>{a(t)})})},getAccDetailsBill:function(){sap.ui.core.BusyIndicator.show();var t=this;var a=this.getOwnerComponent().getModel();var s="/GetAccountDetailsagainstMrnforBillPassing";a.read(s,{urlParameters:{UnitCode:this.UnitCode,MRNnumber:this.MRNnumber},success:function(e){sap.ui.core.BusyIndicator.hide();t.accdetailModel.setData(e);t.accdetailModel.refresh(true)},error:function(t){sap.ui.core.BusyIndicator.hide();e.error(t.message)}})},getAccDetailsVoucher:function(){sap.ui.core.BusyIndicator.show();var t=this;var a=this.getOwnerComponent().getModel();this.MRNDate=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd MMM yyyy"}).format(new Date(this.MRNDate));var s="/GetMRNAccountDetailsforVoucherGeneration";a.read(s,{urlParameters:{UnitCode:this.UnitCode,MRNNumber:this.MRNnumber,MRNDate:this.MRNDate},success:function(e){sap.ui.core.BusyIndicator.hide();t.accdetailModel.setData(e);t.accdetailModel.refresh(true)},error:function(t){sap.ui.core.BusyIndicator.hide();e.error(t.message)}})},onNavPress:function(){history.go(-1)},onRateChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].ActualItemRate=e;this.detailModel.refresh(true)},onTaxAmtChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].ActualTaxAmount=e;this.detailModel.refresh(true)},onTotalChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].MRNLineValue=e;this.detailModel.refresh(true)},onCDTChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].CDT=e;this.detailModel.refresh(true)},onCRTChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].CRT=e;this.detailModel.refresh(true)},onTCSChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].TCS=e;this.detailModel.refresh(true)},onExchRateChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].ExchangeRate=e;this.detailModel.refresh(true)},onOthChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].Others=e;this.detailModel.refresh(true)},onFreightChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].Freight=e;this.detailModel.refresh(true)},onPackChange:function(t){const e=t.getParameter("newValue"),a=t.getSource().getParent().getBindingContext("detailModel").getObject();var s=t.getSource().getParent().getBindingContextPath().split("/")[3];var i=this.detailModel.getData().DocumentRows.results;i[s].Packing=e;this.detailModel.refresh(true)},onBillBookingPress:function(t){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var i={UnitCode:this.UnitCode,CreatedBy:"MA017",CreatedIP:"",BillPassingAccountDetails:[],BillPassingMaterialDetails:[]};for(var o=0;o<this.accdata.length;o++){if(this.accdata[o].BillDate){var r=this.accdata[o].BillDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.BillDate=c.format(n);this.BillDate=this.formatdate(this.BillDate)}if(this.accdata[o].RefDate){var r=this.accdata[o].RefDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.RefDate=c.format(n);this.RefDate=this.formatdate(this.RefDate)}var d={Sno:this.accdata[o].Sno,AccountCode:this.accdata[o].AccountCode,AccountDescription:this.accdata[o].AccountDescription,Particulars:this.accdata[o].Particulars,Amount:this.accdata[o].Amount,AccType:this.accdata[o].AccType,DedTds:this.accdata[o].DedTds,TdsAmount:this.accdata[o].TdsAmount,BillNumber:this.accdata[o].BillNumber,BillDate:this.BillDate,BillAmount:this.accdata[o].Billamount,RefVoucherSlNumber:this.accdata[o].RefVoucherSlNumber,OnlineFlag:this.accdata[o].Onlineflag,BalAmount:this.accdata[o].BalAmount,Flag2:this.accdata[o].Flag2,OtherAmount:this.accdata[o].Otheramount,RefNumber:this.accdata[o].RefNumber,RefDate:this.RefDate,CurrVal:this.accdata[o].CurrVal,RefAmount:this.accdata[o].RefAmount};i.BillPassingAccountDetails.push(d)}if(this.data.DocumentRows.results[0].FRMyear){var r=this.data.DocumentRows.results[0].FRMyear;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.FRMyear=c.format(n);this.FRMyear=this.formatdate(this.FRMyear)}var l={ItemCode:this.data.DocumentRows.results[0].MaterialCode,ItemRevNumber:this.data.DocumentRows.results[0].ItemNumber,Itemdecsription:this.data.DocumentRows.results[0].MaterialDescription,ItemGroupCode:this.data.DocumentRows.results[0].ItemGroupCode,GroupAccCode:this.data.DocumentRows.results[0].GroupAccountCode,GroupAccDesc:this.data.DocumentRows.results[0].GroupAccountDescription,AcceptedQty:this.data.DocumentRows.results[0].AcceptedQty,RejectedQty:this.data.DocumentRows.results[0].RejectedQty,ActualQty:this.data.DocumentRows.results[0].ActualQty,InvoiceQty:this.data.DocumentRows.results[0].InvoiceQty,ItemUom:this.data.DocumentRows.results[0].ItemUOM,MatVal:this.data.DocumentRows.results[0].MaterialValue,CGA:this.data.DocumentRows.results[0].CGA,SGA:this.data.DocumentRows.results[0].SGA,IGA:this.data.DocumentRows.results[0].IGA,Packing:this.data.DocumentRows.results[0].Packing,Freight:this.data.DocumentRows.results[0].Freight,Others:this.data.DocumentRows.results[0].Others,Total:this.data.DocumentRows.results[0].MRNLineValue,ItemRateNew:this.data.DocumentRows.results[0].ItemRate,ItemRate:this.data.DocumentRows.results[0].ActualItemRate,CGP:this.data.DocumentRows.results[0].CGP,SGP:this.data.DocumentRows.results[0].SGP,IGP:this.data.DocumentRows.results[0].IGP,HSNCode:this.data.DocumentRows.results[0].HSNCode,CDT:this.data.DocumentRows.results[0].CDT,CRT:this.data.DocumentRows.results[0].CRT,ExchangeRate:this.data.DocumentRows.results[0].ExchangeRate,BillRate:this.data.DocumentRows.results[0].MRNLineValue,PackingOrg:this.data.DocumentRows.results[0].PakingOrg,FrieghtOrg:this.data.DocumentRows.results[0].FrieghtOrg,OthersOrg:this.data.DocumentRows.results[0].OtherOrg,VoucherNumber:this.data.DocumentRows.results[0].MRNNumber,FromYear:this.FRMyear,TRNLineNumber:this.data.DocumentRows.results[0].TRNLineNumber,TCS:this.data.DocumentRows.results[0].TCS,InvoiceRate:this.data.DocumentRows.results[0].InvoiceRate,CurrPoRate:this.data.DocumentRows.results[0].CurrPORate};i.BillPassingMaterialDetails.push(l);var u=JSON.stringify(i);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var h=this.hardcodedURL+`/v2/odata/v4/catalog/PostBillPassing`;$.ajax({type:"POST",headers:{"Content-Type":"application/json"},url:h,data:JSON.stringify({invoiceData:u}),context:this,success:function(t,a){sap.ui.core.BusyIndicator.hide();e.success("Bill Posted succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(t){if(t==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(t){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(t.responseText);e.error(a.error.message.value)}})},onGenerateVoucherPress:function(t){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var i={UnitCode:this.UnitCode,CreatedBy:"MA017",CreatedIP:"",DetailsList:[],AccountDetails:[]};for(var o=0;o<this.accdata.length;o++){if(this.accdata[o].BillDate){var r=this.accdata[o].BillDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.BillDate=c.format(n);this.BillDate=this.formatdate(this.BillDate)}if(this.accdata[o].RefDate){var r=this.accdata[o].RefDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.RefDate=c.format(n);this.RefDate=this.formatdate(this.RefDate)}var d={Sno:this.accdata[o].Sno,AccountCode:this.accdata[o].AccountCode,AccountDescription:this.accdata[o].AccountDescription,Particulars:this.accdata[o].Particulars,Amount:this.accdata[o].Amount,AccType:this.accdata[o].AccType,DedTds:this.accdata[o].DedTds,TdsAmount:this.accdata[o].TdsAmount,BillNumber:this.accdata[o].BillNumber,BillDate:this.BillDate,BillAmount:this.accdata[o].Billamount,RefVoucherSlNumber:this.accdata[o].RefVoucherSlNumber,OnlineFlag:this.accdata[o].Onlineflag,BalAmount:this.accdata[o].BalAmount,Flag2:this.accdata[o].Flag2,OtherAmount:this.accdata[o].Otheramount,RefNumber:this.accdata[o].RefNumber,RefDate:this.RefDate,CurrVal:this.accdata[o].CurrVal,RefAmount:this.accdata[o].RefAmount};i.AccountDetails.push(d)}if(this.data.MRNDate){var r=this.data.MRNDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.MRNDate=c.format(n);this.MRNDate=this.formatdate(this.MRNDate)}if(this.ReceiptDate){var r=this.ReceiptDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.ReceiptDate=c.format(n);this.ReceiptDate=this.formatdate(this.ReceiptDate)}if(this.SendToAccDate){var r=this.SendToAccDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.SendToAccDate=c.format(n);this.SendToAccDate=this.formatdate(this.SendToAccDate)}var l={Mrnnumber:this.data.DocumentRows.results[0].MRNNumber,Mrndate:this.MRNDate,AccountCode:this.AccCode,AccountDescription:this.AccDesc,ReceiptDate:this.ReceiptDate,Senttoaccountdate:this.SendToAccDate,Generateentry:"1",TotalDebit:this.TotalDebit,TotalCredit:this.TotalCredit,Dedtds:this.DedTds,Partycode:this.data.VendorCode,Trncode:this.data.DocumentRows.results[0].TRNCode,Vouchertype:this.VoucherType,Empcode:"",Tilldatepurchasevalue:this.TillDatePurchaseVal};i.DetailsList.push(l);var u=JSON.stringify(i);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var h=this.hardcodedURL+`/v2/odata/v4/catalog/VoucherGen`;$.ajax({type:"POST",headers:{"Content-Type":"application/json"},url:h,data:JSON.stringify({invoiceData:u}),context:this,success:function(t,a){sap.ui.core.BusyIndicator.hide();e.success("Voucher Generation succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(t){if(t==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(t){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(t.responseText);e.error(a.error.message.value)}})},onCompleteInvoicePress:function(t){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var i={UnitCode:this.UnitCode,CreatedBy:"MA017",CreatedIP:"",VoucherNumber:this.VoucherNumber};var o=JSON.stringify(i);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var r=this.hardcodedURL+`/v2/odata/v4/catalog/PostVoucher`;$.ajax({type:"POST",headers:{"Content-Type":"application/json"},url:r,data:JSON.stringify({invoiceData:o}),context:this,success:function(t,a){sap.ui.core.BusyIndicator.hide();e.success("Voucher Posted succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(t){if(t==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(t){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(t.responseText);e.error(a.error.message.value)}})},formatdate:function(t){const e=t.split("/");const a=parseInt(e[2],10);const s=parseInt(e[1],10)-1;const i=parseInt(e[0],10);const o=new Date(a,s,i);const r=o.getTimezoneOffset()*6e4;const n=new Date(o.getTime()-r);const c=n.toISOString().split("T")[0]+"T00:00:00";return c+"+05:30"}})});