sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sap.fiori.invoicecreation.controller.ASNReportDetail",{onInit:function(){this.detailModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.detailModel,"detailModel");this.accdetailModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.accdetailModel,"accdetailModel");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this);this.byId("uploadSet").setUploadEnabled(false)},handleRouteMatched:function(e){if(e.getParameter("name")==="ASNReportDetail"){var a=this;sap.ui.core.BusyIndicator.show();var s=this.getOwnerComponent().getModel();var o=e.getParameter("arguments");this.UnitCode=o.UnitCode;this.PoNum=o.PoNum.replace(/-/g,"/");this.PNumAttach=o.PoNum;this.MRNnumber=o.MRNnumber.replace(/-/g,"/");this.AddressCode=o.AddressCode;this.SendToAccDate=o.SendToAccDate.replace(/-/g,"/");this.TillDatePurchaseVal=o.TillDatePurchaseVal;this.DedTds=o.DedTds;this.TotalDebit=o.TotalDebit;this.TotalCredit=o.TotalCredit;this.VoucherType=o.VoucherType;this.AccCode=o.AccCode;this.AccDesc=o.AccDesc;this.ReceiptDate=o.ReceiptDate.replace(/-/g,"/");if(this.VoucherNumber!==undefined){this.VoucherNumber=o.VoucherNumber.replace(/-/g,"/")}if(o.ASNNumber){this.ASNNum=o.ASNNumber}var i="/GetPoDetailstoCreateInvoice";s.read(i,{urlParameters:{$expand:"DocumentRows",UnitCode:this.UnitCode,PoNum:this.PoNum,MRNnumber:this.MRNnumber,AddressCode:this.AddressCode},success:function(e){sap.ui.core.BusyIndicator.hide();var s=e.results.find(e=>e.PONumber===a.PoNum);if(s){a.detailModel.setData(s);a.detailModel.refresh(true);for(var o=0;o<a.detailModel.getData().DocumentRows.results.length;o++){a.detailModel.getData().DocumentRows.results[o].ActualItemRate=a.detailModel.getData().DocumentRows.results[o].ItemRate;a.detailModel.getData().DocumentRows.results[o].ShortQuantity=parseFloat(a.detailModel.getData().DocumentRows.results[o].InvoiceQty)-parseFloat(a.detailModel.getData().DocumentRows.results[o].ActualQty)}if(a.VoucherNumber!==undefined){a.detailModel.getData().PVNumber=a.VoucherNumber}else{a.detailModel.getData().PVNumber=""}a.detailModel.refresh(true);a.MRNDate=a.detailModel.getData().MRNDate;if(a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR BILL PASSING"){a.getAccDetailsBill()}else if(a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR VOUCHER GENERATION"||a.detailModel.getData().DocumentRows.results[0].InvoiceStatus==="PENDING FOR VOUCHER POSTING"){a.getAccDetailsVoucher()}if(a.ASNNum){a._fetchFilesForASNNum(a.ASNNum)}else{a._fetchFilesForPoNum(a.PNumAttach)}}else{t.error("Data not found")}},error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.response.body);t.error(a.error.message.value)}})}},_fetchFilesForASNNum:function(e){var t=this.getView().getModel("catalog2");var a=this.byId("uploadSet");a.removeAllItems();t.read("/Files",{filters:[new sap.ui.model.Filter("AsnNum",sap.ui.model.FilterOperator.EQ,e)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});t.setVisibleEdit(false).setVisibleRemove(false);a.addItem(t)})},error:function(e){console.log("Error: "+e)}})},_fetchFilesForPoNum:function(e){var t=this.getView().getModel("catalog1");var a=this.byId("uploadSet");a.removeAllItems();a.setUploadEnabled(false);a.setUploadButtonInvisible(true);t.read("/Files",{filters:[new sap.ui.model.Filter("PNum_PoNum",sap.ui.model.FilterOperator.EQ,e)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});t.setVisibleEdit(false).setVisibleRemove(false);a.addItem(t)})},error:function(e){console.log("Error: "+e)}})},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var a=document.createElement("a");a.href=t;a.setAttribute("download",this._fileName);document.body.appendChild(a);a.click();document.body.removeChild(a)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,a)=>{$.ajax(t).done((t,a,s)=>{e(t)}).fail(e=>{a(e)})})},getAccDetailsBill:function(){sap.ui.core.BusyIndicator.show();var e=this;var a=this.getOwnerComponent().getModel();var s="/GetAccountDetailsagainstMrnforBillPassing";a.read(s,{urlParameters:{UnitCode:this.UnitCode,MRNnumber:this.MRNnumber},success:function(t){sap.ui.core.BusyIndicator.hide();e.accdetailModel.setData(t);e.accdetailModel.refresh(true)},error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.response.body);t.error(a.error.message.value)}})},getAccDetailsVoucher:function(){sap.ui.core.BusyIndicator.show();var e=this;var a=this.getOwnerComponent().getModel();this.MRNDate=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd MMM yyyy"}).format(new Date(this.MRNDate));var s="/GetMRNAccountDetailsforVoucherGeneration";a.read(s,{urlParameters:{UnitCode:this.UnitCode,MRNNumber:this.MRNnumber,MRNDate:this.MRNDate},success:function(t){sap.ui.core.BusyIndicator.hide();e.accdetailModel.setData(t);e.accdetailModel.refresh(true)},error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.response.body);t.error(a.error.message.value)}})},onNavPress:function(){history.go(-1)},onRateChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].ActualItemRate=t;this.detailModel.refresh(true)},onTaxAmtChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].ActualTaxAmount=t;this.detailModel.refresh(true)},onTotalChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].MRNLineValue=t;this.detailModel.refresh(true)},onCDTChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].CDT=t;this.detailModel.refresh(true)},onCRTChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].CRT=t;this.detailModel.refresh(true)},onTCSChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].TCS=t;this.detailModel.refresh(true)},onRemarksChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].Remarks=t;this.detailModel.refresh(true)},onExchRateChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].ExchangeRate=t;this.detailModel.refresh(true)},onOthChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].Others=t;this.detailModel.refresh(true)},onFreightChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].Freight=t;this.detailModel.refresh(true)},onPackChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("detailModel").getObject();var s=e.getSource().getParent().getBindingContextPath().split("/")[3];var o=this.detailModel.getData().DocumentRows.results;o[s].Packing=t;this.detailModel.refresh(true)},onBillBookingPress:function(e){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var o={UnitCode:this.UnitCode,CreatedBy:this.getOwnerComponent().getModel().getHeaders().loginId,CreatedIP:"",BillPassingAccountDetails:[],BillPassingMaterialDetails:[]};for(var i=0;i<this.accdata.length;i++){if(this.accdata[i].BillDate){var r=this.accdata[i].BillDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.BillDate=c.format(n);this.BillDate=this.formatdate(this.BillDate)}if(this.accdata[i].RefDate){var r=this.accdata[i].RefDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.RefDate=c.format(n);this.RefDate=this.formatdate(this.RefDate)}var d={Sno:this.accdata[i].Sno,AccountCode:this.accdata[i].AccountCode,AccountDescription:this.accdata[i].AccountDescription,Particulars:this.accdata[i].Particulars,Amount:this.accdata[i].Amount,AccType:this.accdata[i].AccType,DedTds:this.accdata[i].DedTds,TdsAmount:this.accdata[i].TdsAmount,BillNumber:this.accdata[i].BillNumber,BillDate:this.BillDate,BillAmount:this.accdata[i].Billamount,RefVoucherSlNumber:this.accdata[i].RefVoucherSlNumber,OnlineFlag:this.accdata[i].Onlineflag,BalAmount:this.accdata[i].BalAmount,Flag2:this.accdata[i].Flag2,OtherAmount:this.accdata[i].Otheramount,RefNumber:this.accdata[i].RefNumber,RefDate:this.RefDate,CurrVal:this.accdata[i].CurrVal,RefAmount:this.accdata[i].RefAmount};o.BillPassingAccountDetails.push(d)}for(var i=0;i<this.data.DocumentRows.results.length;i++){if(this.data.DocumentRows.results[i].FRMyear){var r=this.data.DocumentRows.results[0].FRMyear;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.FRMyear=c.format(n);this.FRMyear=this.formatdate(this.FRMyear)}var l={ItemCode:this.data.DocumentRows.results[i].MaterialCode,ItemRevNumber:this.data.DocumentRows.results[i].ItemNumber,Itemdecsription:this.data.DocumentRows.results[i].MaterialDescription,ItemGroupCode:this.data.DocumentRows.results[i].ItemGroupCode,GroupAccCode:this.data.DocumentRows.results[i].GroupAccountCode,GroupAccDesc:this.data.DocumentRows.results[i].GroupAccountDescription,AcceptedQty:this.data.DocumentRows.results[i].AcceptedQty,RejectedQty:this.data.DocumentRows.results[i].RejectedQty,ActualQty:this.data.DocumentRows.results[i].ActualQty,InvoiceQty:this.data.DocumentRows.results[i].InvoiceQty,ItemUom:this.data.DocumentRows.results[i].ItemUOM,MatVal:this.data.DocumentRows.results[i].MaterialValue,CGA:this.data.DocumentRows.results[i].CGA,SGA:this.data.DocumentRows.results[i].SGA,IGA:this.data.DocumentRows.results[i].IGA,Packing:this.data.DocumentRows.results[i].Packing,Freight:this.data.DocumentRows.results[i].Freight,Others:this.data.DocumentRows.results[i].Others,Total:this.data.DocumentRows.results[i].MRNLineValue,ItemRateNew:this.data.DocumentRows.results[i].ItemRate,ItemRate:this.data.DocumentRows.results[i].ActualItemRate,CGP:this.data.DocumentRows.results[i].CGP,SGP:this.data.DocumentRows.results[i].SGP,IGP:this.data.DocumentRows.results[i].IGP,HSNCode:this.data.DocumentRows.results[i].HSNCode,CDT:this.data.DocumentRows.results[i].CDT,CRT:this.data.DocumentRows.results[i].CRT,ExchangeRate:this.data.DocumentRows.results[i].ExchangeRate,BillRate:this.data.DocumentRows.results[i].CurrPORate,PackingOrg:this.data.DocumentRows.results[i].PakingOrg,FrieghtOrg:this.data.DocumentRows.results[i].FrieghtOrg,OthersOrg:this.data.DocumentRows.results[i].OtherOrg,VoucherNumber:this.data.DocumentRows.results[i].MRNNumber,FromYear:this.FRMyear,TRNLineNumber:this.data.DocumentRows.results[i].TRNLineNumber,TCS:this.data.DocumentRows.results[i].TCS,InvoiceRate:this.data.DocumentRows.results[i].InvoiceRate,CurrPoRate:this.data.DocumentRows.results[i].CurrPORate};o.BillPassingMaterialDetails.push(l)}var u=JSON.stringify(o);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var h=this.hardcodedURL+`/v2/odata/v4/catalog/PostBillPassing`;$.ajax({type:"POST",headers:{loginid:a.getOwnerComponent().getModel().getHeaders().loginId,"Content-Type":"application/json"},url:h,data:JSON.stringify({invoiceData:u}),context:this,success:function(e,a){sap.ui.core.BusyIndicator.hide();t.success("Bill Posted succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(e){if(e==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.responseText);t.error(a.error.message.value)}})},onGenerateVoucherPress:function(e){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var o={UnitCode:this.UnitCode,CreatedBy:this.getOwnerComponent().getModel().getHeaders().loginId,CreatedIP:"",DetailsList:[],AccountDetails:[]};for(var i=0;i<this.accdata.length;i++){if(this.accdata[i].BillDate){var r=this.accdata[i].BillDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.BillDate=c.format(n);this.BillDate=this.formatdate(this.BillDate)}if(this.accdata[i].RefDate){var r=this.accdata[i].RefDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.RefDate=c.format(n);this.RefDate=this.formatdate(this.RefDate)}var d={Sno:this.accdata[i].Sno,AccountCode:this.accdata[i].AccountCode,AccountDescription:this.accdata[i].AccountDescription,Particulars:this.accdata[i].Particulars,Amount:this.accdata[i].Amount,AccType:this.accdata[i].AccType,DedTds:this.accdata[i].DedTds,TdsAmount:this.accdata[i].TdsAmount,BillNumber:this.accdata[i].BillNumber,BillDate:this.BillDate,BillAmount:this.accdata[i].Billamount,RefVoucherSlNumber:this.accdata[i].RefVoucherSlNumber,OnlineFlag:this.accdata[i].Onlineflag,BalAmount:this.accdata[i].BalAmount,Flag2:this.accdata[i].Flag2,OtherAmount:this.accdata[i].Otheramount,RefNumber:this.accdata[i].RefNumber,RefDate:this.RefDate,CurrVal:this.accdata[i].CurrVal,RefAmount:this.accdata[i].RefAmount};o.AccountDetails.push(d)}if(this.data.MRNDate){var r=this.data.MRNDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.MRNDate=c.format(n);this.MRNDate=this.formatdate(this.MRNDate)}if(this.ReceiptDate){var r=this.ReceiptDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.ReceiptDate=c.format(n);this.ReceiptDate=this.formatdate(this.ReceiptDate)}if(this.SendToAccDate){var r=this.SendToAccDate;var n=new Date(r);var c=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.SendToAccDate=c.format(n);this.SendToAccDate=this.formatdate(this.SendToAccDate)}var l={Mrnnumber:this.data.DocumentRows.results[0].MRNNumber,Mrndate:this.MRNDate,AccountCode:this.AccCode,AccountDescription:this.AccDesc,ReceiptDate:this.ReceiptDate,Senttoaccountdate:this.SendToAccDate,Generateentry:"1",TotalDebit:this.TotalDebit,TotalCredit:this.TotalCredit,Dedtds:this.DedTds,Partycode:this.data.VendorCode,Trncode:this.data.DocumentRows.results[0].TRNCode,Vouchertype:this.VoucherType,Empcode:"",Tilldatepurchasevalue:this.TillDatePurchaseVal};o.DetailsList.push(l);var u=JSON.stringify(o);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var h=this.hardcodedURL+`/v2/odata/v4/catalog/VoucherGen`;$.ajax({type:"POST",headers:{loginid:a.getOwnerComponent().getModel().getHeaders().loginId,"Content-Type":"application/json"},url:h,data:JSON.stringify({invoiceData:u}),context:this,success:function(e,a){sap.ui.core.BusyIndicator.hide();t.success("Voucher Generation succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(e){if(e==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.responseText);t.error(a.error.message.value)}})},onCompleteInvoicePress:function(e){sap.ui.core.BusyIndicator.show();var a=this;var s=this.getOwnerComponent().getModel();this.accdata=this.accdetailModel.getData().results;this.data=this.detailModel.getData();var o={UnitCode:this.UnitCode,CreatedBy:this.getOwnerComponent().getModel().getHeaders().loginId,CreatedIP:"",VoucherNumber:this.VoucherNumber};var i=JSON.stringify(o);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.invoicecreation")}var r=this.hardcodedURL+`/v2/odata/v4/catalog/PostVoucher`;$.ajax({type:"POST",headers:{loginid:a.getOwnerComponent().getModel().getHeaders().loginId,"Content-Type":"application/json"},url:r,data:JSON.stringify({invoiceData:i}),context:this,success:function(e,a){sap.ui.core.BusyIndicator.hide();t.success("Voucher Posted succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(e){if(e==="OK"){sap.fiori.invoicecreation.controller.formatter.onNavBack()}}})}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.responseText);t.error(a.error.message.value)}})},formatdate:function(e){const t=e.split("/");const a=parseInt(t[2],10);const s=parseInt(t[1],10)-1;const o=parseInt(t[0],10);const i=new Date(a,s,o);const r=i.getTimezoneOffset()*6e4;const n=new Date(i.getTime()-r);const c=n.toISOString().split("T")[0]+"T00:00:00";return c+"+05:30"}})});