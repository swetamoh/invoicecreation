sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/export/Spreadsheet","sap/ui/export/library","sap/m/MessageBox"],function(e,t,a,s){"use strict";return e.extend("sap.fiori.invoicecreation.controller.ASNReportView",{onInit:function(){this.router=sap.ui.core.UIComponent.getRouterFor(this);this.DataModel=new sap.ui.model.json.JSONModel;this.DataModel.setSizeLimit(1e7);this.getView().setModel(this.DataModel,"DataModel");this.invDataModel=new sap.ui.model.json.JSONModel;this.invDataModel.setSizeLimit(1e7);this.getView().setModel(this.DataModel,"invDataModel");this.detailModel=sap.ui.getCore().getModel("detailModel");this.loginModel=sap.ui.getCore().getModel("loginModel");this.getView().setModel(this.loginModel,"loginModel");this.localModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.localModel,"localModel");this._tableTemp=this.getView().byId("tableTempId").clone();this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().setModel(this.oDataModel);var e=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyyMMdd"});this.curDate=new Date;this.curDate=e.format(this.curDate);var t=this;this.unitCode=sessionStorage.getItem("unitCode")||"P01";this.getView().byId("PlantId").setValue(this.unitCode);this.getView().byId("InvStatusId").setSelectedKey("PENDING FOR BILL PASSING");this.InvStatus=this.getView().byId("InvStatusId").getSelectedKey();var a=this.getOwnerComponent().getModel();this.router.attachRoutePatternMatched(this.onRouteMatched,this)},onRouteMatched:function(e){if(e.getParameter("name")!=="ASNReportView"){return}var t=this.getView().byId("mrnstartDateId").getValue();var a=this.getView().byId("mrnendDateId").getValue();if(t&&a){this.onFilterGoPress()}},onFilterClear:function(){var e=this.localModel.getData();e.PONum="";e.MRNNumber="";e.POStartDate="";e.POEndDate="";e.MRNStartDate="";e.MRNEndDate="";this.localModel.refresh(true);var t=this.getView();t.byId("poNumId").setValue("");t.byId("MrnNumId").setValue("");t.byId("postartDateId").setValue("");t.byId("poendDateId").setValue("");t.byId("mrnstartDateId").setValue("");t.byId("mrnendDateId").setValue("")},onFilterGoPress:function(){sap.ui.core.BusyIndicator.show();var e=this;var t=this.localModel.getData();var a=this.getOwnerComponent().getModel();var i=sap.ui.core.format.DateFormat.getDateInstance({pattern:"ddMMMyyyy"});if(!t.MRNStartDate){sap.ui.core.BusyIndicator.hide();s.error("Please enter MRN start date");return}if(!t.MRNEndDate){sap.ui.core.BusyIndicator.hide();s.error("Please enter MRN end date");return}this.POEndDate=this.getView().byId("poendDateId").getDateValue();this.POStartDate=this.getView().byId("postartDateId").getDateValue();if(this.POEndDate){this.POEndDate=i.format(this.POEndDate);this.POEndDate=this.POEndDate.substring(0,2)+" "+this.POEndDate.substring(2,5)+" "+this.POEndDate.substring(5,9)}if(this.POStartDate){this.POStartDate=i.format(this.POStartDate);this.POStartDate=this.POStartDate.substring(0,2)+" "+this.POStartDate.substring(2,5)+" "+this.POStartDate.substring(5,9)}this.MRNEndDate=this.getView().byId("mrnendDateId").getDateValue();this.MRNStartDate=this.getView().byId("mrnstartDateId").getDateValue();if(this.MRNEndDate){this.MRNEndDate=i.format(this.MRNEndDate);this.MRNEndDate=this.MRNEndDate.substring(0,2)+" "+this.MRNEndDate.substring(2,5)+" "+this.MRNEndDate.substring(5,9)}if(this.MRNStartDate){this.MRNStartDate=i.format(this.MRNStartDate);this.MRNStartDate=this.MRNStartDate.substring(0,2)+" "+this.MRNStartDate.substring(2,5)+" "+this.MRNStartDate.substring(5,9)}if(!t.PONum){t.PONum=""}if(!t.MRNNumber){t.MRNNumber=""}if(!t.Plant){this.Plant=this.unitCode}else if(t.Plant){this.Plant=t.Plant}if(!t.POStartDate){this.POStartDate=""}if(!t.POEndDate){this.POEndDate=""}a.read("/GetPendingInvoiceList",{urlParameters:{UnitCode:this.Plant,PoNum:t.PONum,MrnNumber:t.MRNNumber,FromPOdate:this.POStartDate,ToPOdate:this.POEndDate,FromMrndate:this.MRNStartDate,ToMrndate:this.MRNEndDate,Status:t.InvStatus},success:function(t){sap.ui.core.BusyIndicator.hide();e.DataModel.setData(t);e.DataModel.refresh();e.getInvoiceNum()},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.responseText);s.error(t.error.message.value)}})},getInvoiceNum:function(){var e=this;var t=this.getView().getModel("catalog1");t.read("/ASNListHeader",{success:function(t){var a=e.DataModel.getData();for(var s=0;s<a.results.length;s++){if(t.results.find(e=>e.PNum_PoNum===a.results.PONumber)){if(!a.results.BillNumber){a.results.BillNumber=t.results.BillNumber}if(!a.results.BillDate){a.results.BillDate=t.results.BillDate}}}e.DataModel.setData(a);e.DataModel.refresh()},error:function(e){console.log("Error: "+e)}})},onItempress:function(e){var t=e.getParameter("listItem").getBindingContext("DataModel").getProperty();this.PoNum=t.PONumber.replace(/\//g,"-");this.MRNnumber=t.MRNNumber.replace(/\//g,"-");this.SendToAccDate=t.SendToAccDate.replace(/\//g,"-");this.ReceiptDate=t.ReceiptDate.replace(/\//g,"-");this.VoucherNumber=t.VoucherNumber.replace(/\//g,"-");this.ASNNumber=t.ASNNumber.replace(/\//g,"-");this.router.navTo("ASNReportDetail",{UnitCode:t.PlantCode,PoNum:this.PoNum,MRNnumber:this.MRNnumber,AddressCode:t.VendorCode,SendToAccDate:this.SendToAccDate,TillDatePurchaseVal:t.TillDatePurchaseVal,DedTds:t.DedTds,TotalDebit:t.TotalDebit,TotalCredit:t.TotalCredit,VoucherType:t.VoucherType,AccCode:t.AccCode,AccDesc:t.AccDesc,ReceiptDate:this.ReceiptDate,VoucherNumber:this.VoucherNumber,ASNNumber:this.ASNNumber})},onColumnSelection:function(e){var t=this;var a=t.byId("List");var s=this.byId("popOver");if(a!==undefined){a.destroy()}if(s!==undefined){s.destroy()}var i=new sap.m.Popover(this.createId("popOver"),{showHeader:true,placement:sap.m.PlacementType.Bottom,content:[]}).addStyleClass("sapMOTAPopover sapTntToolHeaderPopover sapUiResponsivePadding--header sapUiResponsivePadding--footer");var r=new sap.m.List(this.createId("List"),{});this.byId("popOver").addContent(r);var o=this.getView().byId("TableDataId"),n=o.getColumns();var d=[];for(var l=0;l<n.length;l++){var u=n[l].getAggregation("header").getProperty("text");var h={};h.column=u;d.push(h)}var c=new sap.ui.model.json.JSONModel({list:d});var D=new sap.m.StandardListItem({title:"{oList>column}"});r.setMode("MultiSelect");r.setModel(c);sap.ui.getCore().setModel(c,"oList");var g={path:"oList>/list",template:D};r.bindItems(g);var p=new sap.m.Bar({contentLeft:[],contentMiddle:[new sap.m.Button({text:"Cancel",press:function(){t.onCancel()}})],contentRight:[new sap.m.Button({text:"Save",press:function(){t.onSave()}})]});this.byId("popOver").setFooter(p);var m=this.byId("List");var M=this.byId("TableDataId").getColumns();m.attachEventOnce("updateFinished",function(){var e=[];for(var t=0;t<M.length;t++){var a=m.oModels.undefined.oData.list[t].column;e.push(a);var s=M[t].getHeader().getProperty("text");var i=M[t].getProperty("visible");if(i===true){if(e.indexOf(s)>-1){var r=m.getItems()[t];m.setSelectedItem(r,true)}}}});i.openBy(e.getSource())},onCancel:function(){this.byId("popOver").close()},onSave:function(){var e=this;var t=this.byId("List");var a=[];var s=t.getSelectedItems();for(var i=0;i<s.length;i++){var r=s[i];var o=r.getBindingContext("oList");var n=o.getProperty(null,o);var d=n.column;a.push(d)}var l=this.byId("TableDataId").getColumns();for(var u=0;u<l.length;u++){var h=l[u].getHeader().getProperty("text");var c=l[u].getId();var D=this.getView().byId(c);if(a.indexOf(h)>-1){D.setVisible(true)}else{D.setVisible(false)}}this.byId("popOver").close()},onFromDateChange:function(e){var t=this.getView().byId("postartDateId").getDateValue();var a=this.getView().byId("poendDateId").getDateValue();this.getView().byId("poendDateId").setMinDate(t);if(a<=t){this.getView().byId("poendDateId").setDateValue(new Date(t))}e.getSource().$().find("INPUT").attr("disabled",true).css("color","#000000")}})});